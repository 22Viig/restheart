<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2018-03-06 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Restheart - CPD Results</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20180306" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                Restheart
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2018-03-06</span>
                  &nbsp;| <span id="projectVersion">Version: 3.3.0-SNAPSHOT</span>
                      </div>
            <div class="xright">                    <a href="./" title="Restheart">Restheart</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                          <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                                                                                          <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                                                                                                                            <li class="expanded">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                    <ul>
                      <li class="none">
                          <a href="failsafe-report.html" title="Failsafe Report">Failsafe Report</a>
            </li>
                      <li class="none">
                          <a href="dependency-updates-report.html" title="Dependency Updates Report">Dependency Updates Report</a>
            </li>
                      <li class="none">
                          <a href="plugin-updates-report.html" title="Plugin Updates Report">Plugin Updates Report</a>
            </li>
                      <li class="none">
                          <a href="property-updates-report.html" title="Property Updates Report">Property Updates Report</a>
            </li>
                      <li class="none">
                          <a href="checkstyle.html" title="Checkstyle">Checkstyle</a>
            </li>
                      <li class="none">
                          <a href="findbugs.html" title="FindBugs">FindBugs</a>
            </li>
                      <li class="none">
            <strong>CPD</strong>
          </li>
                      <li class="none">
                          <a href="pmd.html" title="PMD">PMD</a>
            </li>
              </ul>
        </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <div class="section">
<h2>CPD Results<a name="CPD_Results"></a></h2>
<p>The following document contains the results of PMD's  <a class="externalLink" href="http://pmd.sourceforge.net/cpd.html">CPD</a> 6.0.1.</p></div>
<div class="section">
<h2>Duplications<a name="Duplications"></a></h2>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/metadata/RequestTransformerMetadataHandler.java</td>
<td>50</td></tr>
<tr class="a">
<td>org/restheart/handlers/metadata/ResponseTransformerMetadataHandler.java</td>
<td>59</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    public RequestTransformerMetadataHandler(PipedHttpHandler next) {
        super(next);
    }

    @Override
    boolean canCollRepresentationTransformersAppy(RequestContext context) {
        return (!context.isInError()
                &amp;&amp; (context.getType() == RequestContext.TYPE.DOCUMENT
                || context.getType() == RequestContext.TYPE.BULK_DOCUMENTS
                || context.getType() == RequestContext.TYPE.COLLECTION
                || context.getType() == RequestContext.TYPE.AGGREGATION
                || context.getType() == RequestContext.TYPE.FILE
                || context.getType() == RequestContext.TYPE.FILES_BUCKET
                || context.getType() == RequestContext.TYPE.INDEX
                || context.getType() == RequestContext.TYPE.COLLECTION_INDEXES
                || context.getType() == RequestContext.TYPE.SCHEMA_STORE
                || context.getType() == RequestContext.TYPE.SCHEMA)
                &amp;&amp; context.getCollectionProps() != null
                &amp;&amp; context.getCollectionProps()
                        .containsKey(RepresentationTransformer.RTS_ELEMENT_NAME));
    }

    @Override
    boolean canDBRepresentationTransformersAppy(RequestContext context) {
        return (!context.isInError()
                &amp;&amp; (context.getType() == RequestContext.TYPE.DB
                || context.getType() == RequestContext.TYPE.COLLECTION
                || context.getType() == RequestContext.TYPE.FILES_BUCKET
                || context.getType() == RequestContext.TYPE.COLLECTION_INDEXES
                || context.getType() == RequestContext.TYPE.SCHEMA_STORE)
                &amp;&amp; context.getDbProps() != null
                &amp;&amp; context.getDbProps()
                        .containsKey(RepresentationTransformer.RTS_ELEMENT_NAME));
    }

    @Override
    void enforceDbRepresentationTransformLogic(
            HttpServerExchange exchange,
            RequestContext context)
            throws InvalidMetadataException {
        List&lt;RepresentationTransformer&gt; dbRts
                = RepresentationTransformer.getFromJson(context.getDbProps());

        RequestContext.TYPE requestType = context.getType(); // DB, COLLECTION or FILES_BUCKET</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/RequestContext.java</td>
<td>429</td></tr>
<tr class="a">
<td>org/restheart/handlers/RequestContext.java</td>
<td>528</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>        String ret = URLUtils.removeTrailingSlashes(mappedUri);
        String rewriteUri;

        // path template with variables resolved to actual values
        rewriteUri = this.pathTemplateMatch.getMatchedTemplate();

        // remove trailing wildcard from template
        if (rewriteUri.endsWith(&quot;/*&quot;)) {
            rewriteUri = rewriteUri.substring(0, rewriteUri.length() - 2);
        }

        // collect params
        this.pathTemplateMatch
                .getParameters()
                .keySet()
                .stream()
                .filter(key -&gt; !key.equals(&quot;*&quot;))
                .collect(Collectors.toMap(
                        key -&gt; key,
                        key -&gt; this.pathTemplateMatch
                                .getParameters().get(key)));

        // replace params with actual values
        for (String key : this.pathTemplateMatch
                .getParameters().keySet()) {
            rewriteUri = rewriteUri.replace(
                    &quot;{&quot;.concat(key).concat(&quot;}&quot;),
                    this.pathTemplateMatch
                            .getParameters().get(key));
        }

        String whatUri = this.whatUri;

        // replace params with in whatUri
        // eg what: /{account}, where: /{account/*
        for (String key : this.pathTemplateMatch
                .getParameters().keySet()) {
            whatUri = whatUri.replace(
                    &quot;{&quot;.concat(key).concat(&quot;}&quot;),
                    this.pathTemplateMatch
                            .getParameters().get(key));
        }

        // now replace mappedUri with resolved path template
        if (whatUri.equals(&quot;*&quot;)) {
            if (!this.whereUri.equals(SLASH)) {</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/collection/PatchCollectionHandler.java</td>
<td>120</td></tr>
<tr class="a">
<td>org/restheart/handlers/collection/PutCollectionHandler.java</td>
<td>95</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }

        BsonDocument content = _content.asDocument();

        // check RELS metadata
        if (content.containsKey(Relationship.RELATIONSHIPS_ELEMENT_NAME)) {
            try {
                Relationship.getFromJson(content);
            } catch (InvalidMetadataException ex) {
                ResponseHelper.endExchangeWithMessage(
                        exchange,
                        context,
                        HttpStatus.SC_NOT_ACCEPTABLE,
                        &quot;wrong relationships definition. &quot;
                        + ex.getMessage(), ex);
                next(exchange, context);
                return;
            }
        }

        // check RT metadata
        if (content.containsKey(RepresentationTransformer.RTS_ELEMENT_NAME)) {
            try {
                RepresentationTransformer.getFromJson(content);
            } catch (InvalidMetadataException ex) {
                ResponseHelper.endExchangeWithMessage(
                        exchange,
                        context,
                        HttpStatus.SC_NOT_ACCEPTABLE,
                        &quot;wrong representation transformer definition. &quot;
                        + ex.getMessage(), ex);
                next(exchange, context);
                return;
            }
        }

        // check SC metadata
        if (content.containsKey(RequestChecker.ROOT_KEY)) {
            try {
                RequestChecker.getFromJson(content);
            } catch (InvalidMetadataException ex) {
                ResponseHelper.endExchangeWithMessage(
                        exchange,
                        context,
                        HttpStatus.SC_NOT_ACCEPTABLE,
                        &quot;wrong checker definition. &quot;
                        + ex.getMessage(), ex);
                next(exchange, context);
                return;
            }
        }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/db/DocumentRepository.java</td>
<td>28</td></tr>
<tr class="a">
<td>org/restheart/db/Repository.java</td>
<td>28</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>public interface DocumentRepository {

    OperationResult upsertDocument(final String dbName, final String collName, final Object documentId, final BsonDocument filter, final BsonDocument shardedKeys, final BsonDocument content, final String requestEtag, boolean patching, final boolean checkEtag);

    OperationResult upsertDocumentPost(final String dbName, final String collName, final BsonDocument filter, final BsonDocument shardedKeys, final BsonDocument content, final String requestEtag, final boolean checkEtag);

    OperationResult deleteDocument(final String dbName, String collName, Object documentId, final BsonDocument filter, final BsonDocument shardedKeys, final String requestEtag, final boolean checkEtag);

    BulkOperationResult bulkUpsertDocumentsPost(final String dbName, final String collName, final BsonArray documents, final BsonDocument filter, final BsonDocument shardKeys);

    BulkOperationResult bulkPatchDocuments(final String dbName, final String collName, final BsonDocument filter, final BsonDocument shardKeys, final BsonDocument data);

    BulkOperationResult bulkDeleteDocuments(final String dbName, final String collName, final BsonDocument filter, final BsonDocument shardKeys);

    /**
     * returns the ETag of the document
     * @param dbName
     * @param collName
     * @param documentId
     * @return Document containing _etag property
     */
    Document getDocumentEtag(String dbName, String collName, Object documentId);
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/document/PatchDocumentHandler.java</td>
<td>59</td></tr>
<tr class="a">
<td>org/restheart/handlers/files/FileMetadataHandler.java</td>
<td>66</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>    }

    /**
     *
     * @param exchange
     * @param context
     * @throws Exception
     */
    @Override
    public void handleRequest(
            HttpServerExchange exchange,
            RequestContext context)
            throws Exception {
        if (context.isInError()) {
            next(exchange, context);
            return;
        }
        
        BsonValue _content = context.getContent();

        // cannot PATCH with no data
        if (_content == null) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }

        // cannot PATCH an array
        if (!_content.isDocument()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;data must be a json object&quot;);
            next(exchange, context);
            return;
        }
        
        if (_content.asDocument().isEmpty()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/document/PatchDocumentHandler.java</td>
<td>135</td></tr>
<tr class="a">
<td>org/restheart/handlers/files/FileMetadataHandler.java</td>
<td>166</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                true,
                context.isETagCheckRequired());

        context.setDbOperationResult(result);

        // inject the etag
        if (result.getEtag() != null) {
            ResponseHelper.injectEtagHeader(exchange, result.getEtag());
        }

        if (result.getHttpCode() == HttpStatus.SC_CONFLICT) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_CONFLICT,
                    &quot;The document's ETag must be provided using the '&quot;
                    + Headers.IF_MATCH
                    + &quot;' header&quot;);
            next(exchange, context);
            return;
        }
        
        // handle the case of duplicate key error
        if (result.getHttpCode() == HttpStatus.SC_EXPECTATION_FAILED) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_CONFLICT,
                    &quot;A duplicate key error occurred. &quot;
                            + &quot;The patched document does not fulfill &quot;
                            + &quot;an unique index constraint&quot;);

            next(exchange, context);
            return;
        }

        context.setResponseStatusCode(result.getHttpCode());

        next(exchange, context);
    }
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/collection/PatchCollectionHandler.java</td>
<td>88</td></tr>
<tr class="a">
<td>org/restheart/handlers/document/PatchDocumentHandler.java</td>
<td>73</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            next(exchange, context);
            return;
        }

        BsonValue _content = context.getContent();

        if (_content == null) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }

        // cannot PATCH with an array
        if (!_content.isDocument()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;data must be a json object&quot;);
            next(exchange, context);
            return;
        }

        if (_content.asDocument().isEmpty()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }

        BsonDocument content = _content.asDocument();</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/collection/DeleteCollectionHandler.java</td>
<td>65</td></tr>
<tr class="a">
<td>org/restheart/handlers/collection/PatchCollectionHandler.java</td>
<td>182</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>                context.getETag(), context.isETagCheckRequired());

        context.setDbOperationResult(result);

        // inject the etag
        if (result.getEtag() != null) {
            ResponseHelper.injectEtagHeader(exchange, result.getEtag());
        }

        if (result.getHttpCode() == HttpStatus.SC_CONFLICT) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_CONFLICT,
                    &quot;The collection's ETag must be provided using the '&quot;
                    + Headers.IF_MATCH
                    + &quot;' header.&quot;);
            next(exchange, context);
            return;
        }

        context.setResponseStatusCode(result.getHttpCode());

        LocalCachesSingleton.getInstance()
                .invalidateCollection(context.getDBName(), context.getCollectionName());

        next(exchange, context);
    }
}</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/collection/PatchCollectionHandler.java</td>
<td>88</td></tr>
<tr class="a">
<td>org/restheart/handlers/files/FileMetadataHandler.java</td>
<td>74</td></tr>
<tr class="b"><td colspan='2'>
<div>
<pre>            next(exchange, context);
            return;
        }

        BsonValue _content = context.getContent();

        if (_content == null) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }

        // cannot PATCH with an array
        if (!_content.isDocument()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;data must be a json object&quot;);
            next(exchange, context);
            return;
        }

        if (_content.asDocument().isEmpty()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;no data provided&quot;);
            next(exchange, context);
            return;
        }</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="a">
<th>File</th>
<th>Line</th></tr>
<tr class="b">
<td>org/restheart/handlers/document/PatchDocumentHandler.java</td>
<td>135</td></tr>
<tr class="a">
<td>org/restheart/handlers/document/PutDocumentHandler.java</td>
<td>124</td></tr>
<tr class="b">
<td>org/restheart/handlers/files/FileMetadataHandler.java</td>
<td>166</td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>                true,
                context.isETagCheckRequired());

        context.setDbOperationResult(result);

        // inject the etag
        if (result.getEtag() != null) {
            ResponseHelper.injectEtagHeader(exchange, result.getEtag());
        }

        if (result.getHttpCode() == HttpStatus.SC_CONFLICT) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_CONFLICT,
                    &quot;The document's ETag must be provided using the '&quot;
                    + Headers.IF_MATCH
                    + &quot;' header&quot;);
            next(exchange, context);
            return;
        }
        
        // handle the case of duplicate key error
        if (result.getHttpCode() == HttpStatus.SC_EXPECTATION_FAILED) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_CONFLICT,
                    &quot;A duplicate key error occurred. &quot;
                            + &quot;The patched document does not fulfill &quot;</pre></div></td></tr></table>
<table border="0" class="bodyTable">
<tr class="b">
<th>File</th>
<th>Line</th></tr>
<tr class="a">
<td>org/restheart/handlers/collection/PostCollectionHandler.java</td>
<td>62</td></tr>
<tr class="b">
<td>org/restheart/handlers/collection/PutCollectionHandler.java</td>
<td>66</td></tr>
<tr class="a"><td colspan='2'>
<div>
<pre>    }

    /**
     *
     * @param exchange
     * @param context
     * @throws Exception
     */
    @Override
    public void handleRequest(
            HttpServerExchange exchange,
            RequestContext context) throws Exception {
        if (context.isInError()) {
            next(exchange, context);
            return;
        }

        BsonValue _content = context.getContent();

        if (_content == null) {
            _content = new BsonDocument();
        }

        // cannot POST an array
        if (!_content.isDocument()) {
            ResponseHelper.endExchangeWithMessage(
                    exchange,
                    context,
                    HttpStatus.SC_NOT_ACCEPTABLE,
                    &quot;data must be a json object&quot;);
            next(exchange, context);
            return;
        }

        BsonDocument content = _content.asDocument();

        if (content.containsKey(&quot;_id&quot;)</pre></div></td></tr></table></div>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              Copyright &#169;                    2014-2018
                        <a href="http://www.softinstigate.com">SoftInstigate</a>.
            All Rights Reserved.      
                    
                  </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
